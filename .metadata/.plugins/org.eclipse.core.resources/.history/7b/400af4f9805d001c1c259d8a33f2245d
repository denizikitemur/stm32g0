/*
 * bsp.c
 *
 *  Created on: Dec 1, 2021
 *      Author: antih
 */
#include "stm32g0xx.h"
#include "bsp.h"
static int arr[256]=0x1f40,0x2004,0x20c9,0x218d,0x2250,0x2313,0x23d6,0x2498,0x2559,0x2619,0x26d8,0x2796,0x2852,0x290d,0x29c7,0x2a7f,0x2b35,0x2bea,0x2c9c,0x2d4d,0x2dfb,0x2ea7,0x2f51,0x2ff8,0x309d,0x313e,0x31de,0x327a,0x3313,0x33a9,0x343c,0x34cc,0x3559,0x35e2,0x3668,0x36ea,0x3768,0x37e3,0x385a,0x38cd,0x393c,0x39a7,0x3a0e,0x3a71,0x3acf,0x3b2a,0x3b80,0x3bd2,0x3c1f,0x3c68,
0x3cac,0x3cec,0x3d28,0x3d5e,0x3d90,0x3dbe,0x3de6,0x3e0a,0x3e29,0x3e44,0x3e59,0x3e6a,0x3e76,0x3e7e,0x3e80,0x3e7e,0x3e76,0x3e6a,0x3e59,0x3e44,0x3e29,0x3e0a,0x3de6,0x3dbe,0x3d90,0x3d5e,0x3d28,0x3cec,0x3cac,0x3c68,0x3c1f,0x3bd2,0x3b80,0x3b2a,0x3acf,0x3a71,0x3a0e,0x39a7,0x393c,0x38cd,0x385a,0x37e3,0x3768,0x36ea,0x3668,0x35e2,0x3559,0x34cc,0x343c,0x33a9,
0x3313,0x327a,0x31de,0x313e,0x309d,0x2ff8,0x2f51,0x2ea7,0x2dfb,0x2d4d,0x2c9c,0x2bea,0x2b35,0x2a7f,0x29c7,0x290d,0x2852,0x2796,0x26d8,0x2619,0x2559,0x2498,0x23d6,0x2313,0x2250,0x218d,0x20c9,0x2004,0x1f40,0x1e7c,0x1db7,0x1cf3,0x1c30,0x1b6d,0x1aaa,0x19e8,0x1927,0x1867,0x17a8,0x16ea,0x162e,0x1573,0x14b9,0x1401,0x134b,0x1296,0x11e4,0x1133,0x1085,0xfd9,
0xf2f,0xe88,0xde3,0xd42,0xca2,0xc06,0xb6d,0xad7,0xa44,0x9b4,0x927,0x89e,0x818,0x796,0x718,0x69d,0x626,0x5b3,0x544,0x4d9,0x472,0x40f,0x3b1,0x356,0x300,0x2ae,0x261,0x218,0x1d4,0x194,0x158,0x122,0xf0,0xc2,0x9a,0x76,0x57,0x3c,0x27,0x16,0xa,0x2,0x0,0x2,0xa,0x16,0x27,0x3c,0x57,0x76,
0x9a,0xc2,0xf0,0x122,0x158,0x194,0x1d4,0x218,0x261,0x2ae,0x300,0x356,0x3b1,0x40f,0x472,0x4d9,0x544,0x5b3,0x626,0x69d,0x718,0x796,0x818,0x89e,0x927,0x9b4,0xa44,0xad7,0xb6d,0xc06,0xca2,0xd42,0xde3,0xe88,0xf2f,0xfd9,0x1085,0x1133,0x11e4,0x1296,0x134b,0x1401,0x14b9,0x1573,0x162e,0x16ea,0x17a8,0x1867,0x1927,0x19e8,
0x1aaa,0x1b6d,0x1c30,0x1cf3,0x1db7,0x1e7c,0x1f40};
static int f[0]={50};

#define LEDDELAY    160000;



void system_init(){

	__disable_irq();
	init_pwm2();
	__enable_irq();
}


//INITILIZE ONBOARD LED CONNECTED TO PC6 PIN AND CONFIGURATION
void onboardLed_Set(){
    /* Enable GPIOC clock */
    RCC->IOPENR |= (1U << 2);
    /* Setup PC6 as output for onboard led*/
    GPIOC->MODER &= ~(3U << 2*6);
    GPIOC->MODER |= (1U << 2*6);
}
void onboardLed_TurnOn(){
    /* Turn on LED */
    GPIOC->ODR |= (1U << 6);
}
void onboardLed_TurnOff(){
    /* Turn on LED */
    GPIOC->BRR |= (1U << 6);
}
void onboardLed_Toggle(){
    /* Turn on LED */
    GPIOC->ODR ^= (1U << 6);
}


//INITILIZE BUTTON CONNECTED TO PA5 PIN

void button_set(){
    /* Enable GPIOA clock */
    RCC->IOPENR |= (1U << 0);
	//Set PA5 as input
	GPIOA->MODER &= ~(3U << 2*5);
}
//RETURNS 1 IF BUTTONS PRESSED
int button_read(){
	int b = ((GPIOA->IDR >>5 ) & 0X1);
	if(b)
		return 0;
	else return 1;
}

//BUTTON WITH EXTERNAL INTERRUPTS
void button_interrupt(){
	//Set PA5 as input
	EXTI->RTSR1 |= (1U << 5);
	EXTI->EXTICR[5] |= (1U << 8*5);
	EXTI->IMR1 |= (1U << 5);

	NVIC_SetPriority(EXTI4_15_IRQn, 0);
	NVIC_EnableIRQ(EXTI4_15_IRQn);
}

//PWM MEWZULARI

void TIM2_IRQHandler(void){

	TIM2->SR &= ~(1U << 0);
}

void init_pwm2(){
	//WORKING WITH PB3 PIN'S AF2 FUNCTION AS TIM2_CH2
	//enable gpiob
	RCC->IOPENR |= (1U << 1);
	//enable tim2 clock
	RCC->APBENR1 |= RCC_APBENR1_TIM2EN;


	//select AF from moder
	GPIOB->MODER &= ~(3U << 2*3);
	GPIOB->MODER |= (2U << 2*3);
	//set alternate function 2 // 0010 FOR AF2
	GPIOB->AFR[0] &= ~(0XFU << 4*3);
	GPIOB->AFR[0] |= (2U << 4*3);



    // zero out the control register just in case
	TIM2->CR1 = 0;

    // Select PWM Mode 1
    TIM2->CCMR1 |= (6U << 12);
    // Preload Enable
    TIM2->CCMR1 |= TIM_CCMR1_OC2PE;

    // Capture compare ch2 enable
    TIM2->CCER |= TIM_CCER_CC2E;

    // zero out counter
    TIM2->CNT = 0;
    // 1 ms interrupt
    TIM2->PSC = (16*10^6*16*10^3)*f[0]-1;
    TIM2->ARR = 15999;

    // zero out duty
int i;
for(i=0; i<256; i++){
    TIM2->CCR2 = arr[i];
}
    // Update interrupt enable
    TIM2->DIER |= (1 << 0);

    // TIM1 Enable
    TIM2->CR1 |= TIM_CR1_CEN;

    NVIC_SetPriority(TIM2_IRQn, 1);
    NVIC_EnableIRQ(TIM2_IRQn);

}
